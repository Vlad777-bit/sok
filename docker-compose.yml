services:
    db:
        image: postgres:17
        environment:
            - 'POSTGRES_DB=${POSTGRES_DB}'
            - 'POSTGRES_USER=${POSTGRES_USER}'
            - 'POSTGRES_PASSWORD=${POSTGRES_PASSWORD}'
        ports:
            - '${POSTGRES_PORT}:5432'
        volumes:
            - sok_pgdata:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}',
                ]
            interval: 5s
            timeout: 5s
            retries: 10

    backend:
        build:
            context: ./backend
        environment:
            - 'APP_HOST=${APP_HOST}'
            - 'APP_PORT=${APP_PORT}'

            - 'DB_NAME=${POSTGRES_DB}'
            - 'DB_USER=${POSTGRES_USER}'
            - 'DB_PASSWORD=${POSTGRES_PASSWORD}'
            - 'DB_HOST=db'
            - 'DB_PORT=5432'

            - 'CORS_ORIGINS=${CORS_ORIGINS}'

            - 'JWT_SECRET_KEY=${JWT_SECRET_KEY}'
            - 'JWT_ALGORITHM=${JWT_ALGORITHM}'
            - 'JWT_EXPIRES_MINUTES=${JWT_EXPIRES_MINUTES}'

            - 'LOG_LEVEL=${LOG_LEVEL}'
        depends_on:
            db:
                condition: service_healthy
        ports:
            - '${APP_PORT}:8000'

    web:
        build:
            context: ./frontend
            args:
                VITE_API_BASE_URL: '/api'
        depends_on:
            - backend
        ports:
            - '8080:80'

volumes:
    sok_pgdata:
